name: "Playwright Test Runner"
on:
  workflow_call:
    inputs:
      dotnet-version:
        type: string
        required: false
        default: "8.0.x"
        description: ".NET SDK version to use"
      test-filter:
        type: string
        required: false
        default: "FullyQualifiedName~Tests"
        description: "Filter for selecting which tests to run."
      test-name:
        type: string
        required: false
        default: "End-to-End Tests"
        description: "Name for the test job (e.g., 'End-to-End Tests')"
      test-project-path:
        type: string
        required: true
        description: "Path to the test project directory for Playwright Tests."
      base-url:
        type: string
        required: true
        description: "Base URL for the application under test"

jobs:
  run-tests:
    name: ${{ inputs.test-name }}
    runs-on: "ubuntu-latest"
    permissions:
      contents: read
      actions: write  # needed to save caches
    steps:
    - name: "Checkout repository"
      uses: actions/checkout@v4

    - name: "Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: "Cache NuGet packages"
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj', '**/*.sln') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: "Restore dependencies"
      run: dotnet restore

    - name: "Build test project for Playwright"
      run: dotnet build
      working-directory: ${{ inputs.test-project-path }}

    - name: "Install Playwright CLI"
      run: dotnet tool install --global Microsoft.Playwright.CLI

    - name: "Verify Playwright CLI installation"
      run: playwright --version
      working-directory: ${{ inputs.test-project-path }}

    - name: "Install Playwright browsers"
      run: playwright install --with-deps
      working-directory: ${{ inputs.test-project-path }}

    - name: "Output BASE_URL for debugging"
      run: echo "BASE_URL=${{ inputs.base-url }}"

    - name: "Run Tests"
      id: run_tests
      env:
        BASE_URL: ${{ inputs.base-url }}
      continue-on-error: true
      run: dotnet test --filter '${{ inputs.test-filter }}' --no-build --verbosity normal

    - name: "Add test summary"
      if: always()
      run: |
        echo "### ${{ inputs.test-name }} Results" >> $GITHUB_STEP_SUMMARY
        if [ ${{ steps.run_tests.outcome }} == 'success' ]; then
          echo "All tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "Tests failed" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: "Check for test failures"
      if: steps.run_tests.outcome == 'failure'
      run: exit 1
